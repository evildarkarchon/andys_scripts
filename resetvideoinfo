#!/usr/bin/env python3
# pylint: disable=w0611
import pathlib
import argparse
from sqlalchemy import create_engine, Column, Float, Integer, String
from sqlalchemy.ext.declarative import declarative_base
from sqlalchemy.orm import sessionmaker

from andy2.util import Util, Mood
from andy2.videoinfo import VideoInfo, VideoJSON, VideoData, FindVideoInfo, sqa_session

args = argparse.ArgumentParser(description="genvideoinfo: a simple video metadata extractor.")
args.add_argument("--verbose", "-v", action="store_true", help="Run in verbose mode.")
args.add_argument("--regen-json", "-rj", action="store_true", help="Regenerate the json cache as well")
args.add_argument("directory", default="/data/Private", nargs="?", help="Directory to look for videoinfo databases")

options = vars(args.parse_args())
del args

fvi = FindVideoInfo()

directories = list(fvi.find(options["directory"]))

for directory in directories:
    path = pathlib.Path(directory).resolve()
    def gfl():
        """Generator function that iterates over the directory specified in the directory variable and yields all files contained within."""

        for filename in path.iterdir():  # pylint: disable=e1101, w0640, w0621
            yield str(filename)

    files = list(gfl())

    vd = VideoData(db=str(path.joinpath("videoinfo.sqlite")), verbose=options["verbose"], regen=True, regenjson=options["regen_json"])

    database = create_engine("sqlite:///{}".format(str(path.joinpath("videoinfo.sqlite"))))
    sm = sessionmaker(bind=database)
    session = sm()
    filelist = Util.sortentries(list(vd.genfilelist(files)))
    filehashes = dict(vd.genhashlist(filelist))
    for filename in filelist:
        print("{} Putting information from {} into the database.".format(Mood.happy(), pathlib.Path(filename).name))
        vi = VideoInfo()
        vj = VideoJSON()
        filejson = vd.parse(filename)
        # print(filehashes)

        if options["verbose"]:
            filedict = VideoData.gendict(filename, filejson, filehashes[filename], True)
        else:
            filedict = VideoData.gendict(filename, filejson, filehashes[filename])
        with sqa_session(session) as sess:
            vi.filename = filedict["filename"]
            vi.duration = filedict["duration"]
            vi.duration_raw = filedict["duration_raw"]
            vi.numstreams = filedict["numstreams"]
            vi.container = filedict["container"]
            vi.width = filedict["width"]
            vi.height = filedict["height"]
            vi.frame_rate = filedict["frame_rate"]
            vi.type_0 = filedict["type_0"]
            vi.type_1 = filedict["type_1"]
            vi.codec_0 = filedict["codec_0"]
            vi.codec_1 = filedict["codec_1"]
            vi.bitrate_0 = filedict["bitrate_0"]
            vi.bitrate_0_raw = filedict["bitrate_0_raw"]
            vi.bitrate_1 = filedict["bitrate_1"]
            vi.bitrate_1_raw = filedict["bitrate_1_raw"]
            vi.bitrate_total = filedict["bitrate_total"]
            vi.filehash = filedict["hash"]
            vi.jsondata = filedict["jsondata"]
            if not session.query(VideoJSON).filter(VideoJSON.filename == filedict["filename"]).count() >= 1 or options["regen_json"]:
                vj.json = filedict["jsondata"]
                vj.filename = filedict["filename"]
                sess.add(vj)
            sess.add(vi)
        del vi
        del filejson
        del filedict
