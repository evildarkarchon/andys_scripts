#!/usr/bin/env ruby
# frozen_string_literal: true

require 'pathname'
require 'fileutils'
require 'optparse'
require 'ostruct'

require_relative 'andyrb/util/program'
require_relative 'andyrb/util/datediff'
require_relative 'andyrb/git'
require_relative 'andyrb/mood'
require_relative 'andyrb/core/cleanup'

class Options
  def self.parse(args)
    options = OpenStruct.new
    options.aggressive = false
    options.replace = false
    options.restart = false
    options.gc = false

    optparse = OptionParser.new do |opts|
      opts.on('-a', '--aggressive', 'Activate git gc in aggressive mode if run.') { options.aggressive = true }
      opts.on('-r', '--replace', 'Rename any existing directory if a repository is not found.') { options.replace = true }
      opts.on('-g', '--garbage-collect', 'Force garbage collection to run.') { options.gc = true }
      opts.on('--restart-ttrssd', 'Restart ttrssd.') { options.restart = true }
    end
    optparse.parse!(args)
    options
  end
end

ARGV.cleanup!
Args = Options.parse(ARGV)
Args.freeze
TTrss = Git.new('/data/web/feeds', use_sudo: true, sudo_user: 'nginx')
at_exit do
  TTrss.clean_lock
end

def touchgcfile
  cachepath = Pathname.new('/var/cache/ttrssgc').freeze

  use_sudo = false
  use_sudo = true unless cachepath.parent.writable?
  use_sudo.freeze

  case
  when use_sudo
    Util::Program.runprogram(%W(touch #{cachepath}), use_sudo: true)
  else
    FileUtils.touch(cachepath.to_s)
  end
end

touchgcfile unless File.exist?('/var/cache/ttrssgc')

def ttrssgc(thendate)
  diff = Util.datediff(thendate).freeze
  begin
    TTrss.gc(aggressive: Args.aggressive) if diff >= 30 || Args.gc
  rescue Interrupt => e
    raise e
  else
    touchgcfile if diff >= 30 || Args.gc
  end
end

repopath = Pathname.new('/data/web/feeds/.git').freeze
wdpath = repopath.parent.freeze
giturl = 'https://tt-rss.org/gitlab/fox/tt-rss.git'
case
when repopath.directory?
  TTrss.clean_lock
  TTrss.pull
when wdpath.exist? && !repopath.exist?
  case
  when Args.replace
    puts(Mood.neutral { "No git repository located in the target directory, renaming it to #{wdpath}.old" })
    Util::Program.runprogram(%W(mv #{wdpath} #{wdpath}.old), use_sudo: true, sudo_user: 'nginx')
    TTrss.clone(giturl)
  else
    raise 'No git repository located in the target directory.'
  end
when wdpath.file?
  puts Mood.neutral('Target location is a file, renaming and cloning repository.')
  Util::Program.runprogram(%W(mv #{wdpath} #{wdpath}.bad), use_sudo: true, sudo_user: 'nginx')
  TTrss.clone(giturl)
else
  puts Mood.neutral('Target location does not exist, cloning repository')
  TTrss.clone(giturl)
end

ttrssgc(File.stat('/var/cache/ttrssgc').mtime)

Util::Program.runprogram(%w(systemctl restart ttrssd)) if Args.restart
